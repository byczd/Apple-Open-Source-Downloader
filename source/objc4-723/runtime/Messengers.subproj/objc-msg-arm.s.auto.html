<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>objc-msg-arm.s</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">objc-msg-arm.s&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="objc-msg-arm.s">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
/*
 <span class="enscript-keyword">*</span> @APPLE_LICENSE_HEADER_START@
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> Copyright (c) 1999-2007 Apple Computer, Inc.  All Rights Reserved.
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> This file contains Original Code and/or Modifications of Original Code
 <span class="enscript-keyword">*</span> as defined in and that are subject to the Apple Public Source License
 <span class="enscript-keyword">*</span> Version 2.0 (the 'License'). You may not use this file except in
 <span class="enscript-keyword">*</span> compliance with the License. Please obtain a copy of the License at
 <span class="enscript-keyword">*</span> <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this
 <span class="enscript-keyword">*</span> file.
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> The Original Code and all software distributed under the License are
 <span class="enscript-keyword">*</span> distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 <span class="enscript-keyword">*</span> EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 <span class="enscript-keyword">*</span> INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 <span class="enscript-keyword">*</span> FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 <span class="enscript-keyword">*</span> Please see the License for the specific language governing rights and
 <span class="enscript-keyword">*</span> limitations under the License.
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> @APPLE_LICENSE_HEADER_END@
 <span class="enscript-keyword">*/
</span>/********************************************************************
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span>  objc-msg-arm.s - ARM code to support objc messaging
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">********************************************************************/
</span>
#ifdef __arm__
	<span class="enscript-keyword">
</span>#include &lt;arm/arch.h&gt;

#ifndef _ARM_ARCH_7
#   error requires armv7
#endif

// Set FP=1 on architectures that pass parameters in floating-point registers
#if __ARM_ARCH_7K__
#   define FP 1
#else
#   define FP 0
#endif

#if FP

#   if !__ARM_NEON__
#       error sorry
#   endif

#   define FP_RETURN_ZERO \
	<span class="enscript-keyword">vmov.i32</span>  q0, #0  <span class="enscript-comment">; \
	vmov.i32  q1, #0  ; \
</span>	<span class="enscript-keyword">vmov.i32</span>  q2, #0  <span class="enscript-comment">; \
	vmov.i32  q3, #0
</span>
#   define FP_SAVE \
	<span class="enscript-keyword">vpush</span>	{q0-q3}

#   define FP_RESTORE \
	<span class="enscript-keyword">vpop</span>	{q0-q3}

#else

#   define FP_RETURN_ZERO
#   define FP_SAVE
#   define FP_RESTORE

#endif

// Define SUPPORT_INDEXED_ISA for targets which store the class in the ISA as
// an index in to a class table.
// Note, keep this in sync with objc-config.h.
// FIXME: Remove this duplication.  We should get this from objc-config.h.
#if __ARM_ARCH_7K__ &gt;= 2
#   define SUPPORT_INDEXED_ISA 1
#else
#   define SUPPORT_INDEXED_ISA 0
#endif

// Note, keep these in sync with objc-private.h
#define ISA_INDEX_IS_NPI      1
#define ISA_INDEX_MASK        0x0001FFFC
#define ISA_INDEX_SHIFT       2
#define ISA_INDEX_BITS        15
#define ISA_INDEX_COUNT       (1 &lt;&lt; ISA_INDEX_BITS)
#define ISA_INDEX_MAGIC_MASK  0x001E0001
#define ISA_INDEX_MAGIC_VALUE 0x001C0001

.syntax unified	
	<span class="enscript-keyword">
</span>#define MI_EXTERN(var) \
	<span class="enscript-keyword">.non_lazy_symbol_pointer</span>                        <span class="enscript-comment">;\
L##var##$$non_lazy_ptr:                                 ;\
</span>	<span class="enscript-keyword">.indirect_symbol</span> var                            <span class="enscript-comment">;\
	.long 0
</span>
#define MI_GET_EXTERN(reg,var)  \
	<span class="enscript-keyword">movw</span>	reg, :lower16:(L##var##$$non_lazy_ptr-7f-4)  <span class="enscript-comment">;\
	movt	reg, :upper16:(L##var##$$non_lazy_ptr-7f-4)  ;\
</span><span class="enscript-function-name">7:</span>	add	reg, pc                                      <span class="enscript-comment">;\
	ldr	reg, [reg]
</span>	<span class="enscript-keyword">
</span>#define MI_GET_ADDRESS(reg,var)  \
	<span class="enscript-keyword">movw</span>	reg, :lower16:(var-7f-4)  <span class="enscript-comment">;\
	movt	reg, :upper16:(var-7f-4)  ;\
</span><span class="enscript-function-name">7:</span>	add	reg, pc                                     <span class="enscript-comment">;\

</span>
.data

#if SUPPORT_INDEXED_ISA

	<span class="enscript-keyword">.align</span> 2
	<span class="enscript-keyword">.globl</span> _objc_indexed_classes
<span class="enscript-function-name">_objc_indexed_classes:</span>
	<span class="enscript-keyword">.fill</span> ISA_INDEX_COUNT, 4, 0

#endif



// _objc_entryPoints and _objc_exitPoints are used by method dispatch
// caching code to figure out whether any threads are actively 
// in the cache for dispatching.  The labels surround the asm code
// that do cache lookups.  The tables are zero-terminated.

.align 2
.private_extern _objc_entryPoints
<span class="enscript-function-name">_objc_entryPoints:</span>
	<span class="enscript-keyword">.long</span>   _cache_getImp
	<span class="enscript-keyword">.long</span>   _objc_msgSend
	<span class="enscript-keyword">.long</span>   _objc_msgSend_stret
	<span class="enscript-keyword">.long</span>   _objc_msgSendSuper
	<span class="enscript-keyword">.long</span>   _objc_msgSendSuper_stret
	<span class="enscript-keyword">.long</span>   _objc_msgSendSuper2
	<span class="enscript-keyword">.long</span>   _objc_msgSendSuper2_stret
	<span class="enscript-keyword">.long</span>   _objc_msgLookup
	<span class="enscript-keyword">.long</span>   _objc_msgLookup_stret
	<span class="enscript-keyword">.long</span>   _objc_msgLookupSuper2
	<span class="enscript-keyword">.long</span>   _objc_msgLookupSuper2_stret
	<span class="enscript-keyword">.long</span>   0

.private_extern _objc_exitPoints
<span class="enscript-function-name">_objc_exitPoints:</span>
	<span class="enscript-keyword">.long</span>   LExit_cache_getImp
	<span class="enscript-keyword">.long</span>   LExit_objc_msgSend
	<span class="enscript-keyword">.long</span>   LExit_objc_msgSend_stret
	<span class="enscript-keyword">.long</span>   LExit_objc_msgSendSuper
	<span class="enscript-keyword">.long</span>   LExit_objc_msgSendSuper_stret
	<span class="enscript-keyword">.long</span>   LExit_objc_msgSendSuper2
	<span class="enscript-keyword">.long</span>   LExit_objc_msgSendSuper2_stret
	<span class="enscript-keyword">.long</span>   LExit_objc_msgLookup
	<span class="enscript-keyword">.long</span>   LExit_objc_msgLookup_stret
	<span class="enscript-keyword">.long</span>   LExit_objc_msgLookupSuper2
	<span class="enscript-keyword">.long</span>   LExit_objc_msgLookupSuper2_stret
	<span class="enscript-keyword">.long</span>   0


/********************************************************************
* List every exit insn from every messenger for debugger use.
* Format:
* (
*   1 word instruction's address
*   1 word type (ENTER or FAST_EXIT or SLOW_EXIT or NIL_EXIT)
* )
* 1 word zero
*
* ENTER is the start of a dispatcher
* FAST_EXIT is method dispatch
* SLOW_EXIT is uncached method lookup
* NIL_EXIT is returning zero from a message sent to nil
* These must match objc-gdb.h.
********************************************************************/
	<span class="enscript-keyword">
</span>#define ENTER     1
#define FAST_EXIT 2
#define SLOW_EXIT 3
#define NIL_EXIT  4

.section __DATA,__objc_msg_break
.globl _gdb_objc_messenger_breakpoints
<span class="enscript-function-name">_gdb_objc_messenger_breakpoints:</span>
// contents populated by the macros below

.macro MESSENGER_START
<span class="enscript-function-name">7:</span>
	<span class="enscript-keyword">.section</span> __DATA,__objc_msg_break
	<span class="enscript-keyword">.long</span> 7b
	<span class="enscript-keyword">.long</span> ENTER
	<span class="enscript-keyword">.text
</span>.endmacro
.macro MESSENGER_END_FAST
<span class="enscript-function-name">7:</span>
	<span class="enscript-keyword">.section</span> __DATA,__objc_msg_break
	<span class="enscript-keyword">.long</span> 7b
	<span class="enscript-keyword">.long</span> FAST_EXIT
	<span class="enscript-keyword">.text
</span>.endmacro
.macro MESSENGER_END_SLOW
<span class="enscript-function-name">7:</span>
	<span class="enscript-keyword">.section</span> __DATA,__objc_msg_break
	<span class="enscript-keyword">.long</span> 7b
	<span class="enscript-keyword">.long</span> SLOW_EXIT
	<span class="enscript-keyword">.text
</span>.endmacro
.macro MESSENGER_END_NIL
<span class="enscript-function-name">7:</span>
	<span class="enscript-keyword">.section</span> __DATA,__objc_msg_break
	<span class="enscript-keyword">.long</span> 7b
	<span class="enscript-keyword">.long</span> NIL_EXIT
	<span class="enscript-keyword">.text
</span>.endmacro

	<span class="enscript-keyword">
</span>/********************************************************************
 <span class="enscript-keyword">*</span> Names for relative labels
 <span class="enscript-keyword">*</span> DO NOT USE THESE LABELS ELSEWHERE
 <span class="enscript-keyword">*</span> Reserved labels: 6: 7: 8: 9:
 <span class="enscript-keyword">********************************************************************/
</span>// 6: used by CacheLookup
// 7: used by MI_GET_ADDRESS etc and MESSENGER_START etc
// 8: used by CacheLookup
#define LNilReceiver 	9
#define LNilReceiver_f 	9f
#define LNilReceiver_b 	9b


/********************************************************************
 <span class="enscript-keyword">*</span> Macro parameters
 <span class="enscript-keyword">********************************************************************/
</span>
#define NORMAL 0
#define STRET 1


/********************************************************************
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> Structure definitions.
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">********************************************************************/
</span>
/* objc_super parameter to sendSuper */
#define RECEIVER         0
#define CLASS            4

/* Selected field offsets in class structure */
#define ISA              0
#define SUPERCLASS       4
#define CACHE            8
#define CACHE_MASK      12

/* Selected field offsets in method structure */
#define METHOD_NAME      0
#define METHOD_TYPES     4
#define METHOD_IMP       8


//////////////////////////////////////////////////////////////////////
//
// ENTRY		functionName
//
// Assembly directives to begin an exported function.
//
// Takes: functionName - name of the exported function
//////////////////////////////////////////////////////////////////////

.macro ENTRY /* name */
	<span class="enscript-keyword">.text
</span>	<span class="enscript-keyword">.thumb
</span>	<span class="enscript-keyword">.align</span> 5
	<span class="enscript-keyword">.globl</span> $0
	<span class="enscript-keyword">.thumb_func
</span><span class="enscript-function-name">$0:</span>	
.endmacro

.macro STATIC_ENTRY /*name*/
	<span class="enscript-keyword">.text
</span>	<span class="enscript-keyword">.thumb
</span>	<span class="enscript-keyword">.align</span> 5
	<span class="enscript-keyword">.private_extern</span> $0
	<span class="enscript-keyword">.thumb_func
</span><span class="enscript-function-name">$0:</span>	
.endmacro
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">
</span>//////////////////////////////////////////////////////////////////////
//
// END_ENTRY	functionName
//
// Assembly directives to end an exported function.  Just a placeholder,
// a close-parenthesis for ENTRY, until it is needed for something.
//
// Takes: functionName - name of the exported function
//////////////////////////////////////////////////////////////////////

.macro END_ENTRY /* name */
<span class="enscript-function-name">LExit$0:</span>	
.endmacro


/////////////////////////////////////////////////////////////////////
//
// CacheLookup	NORMAL|STRET
// CacheLookup2	NORMAL|STRET
//
// Locate the implementation for a selector in a class's method cache.
//
// Takes: 
//	  $0 = NORMAL, STRET
//	  r0 or r1 (STRET) = receiver
//	  r1 or r2 (STRET) = selector
//	  r9 = class to search in
//
// On exit: r9 clobbered
//	    (found) continues after CacheLookup, IMP in r12, eq set
//	    (not found) continues after CacheLookup2
//
/////////////////////////////////////////////////////////////////////
	<span class="enscript-keyword">
</span>.macro CacheLookup
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">ldrh</span>	r12, [r9, #CACHE_MASK]	// r12 = mask
	<span class="enscript-keyword">ldr</span>	r9, [r9, #CACHE]	// r9 = buckets
.if $0 == STRET
	<span class="enscript-keyword">and</span>	r12, r12, r2		// r12 = index = SEL &amp; mask
.else
	<span class="enscript-keyword">and</span>	r12, r12, r1		// r12 = index = SEL &amp; mask
.endif
	<span class="enscript-keyword">add</span>	r9, r9, r12, LSL #3	// r9 = bucket = buckets+index*8
	<span class="enscript-keyword">ldr</span>	r12, [r9]		// r12 = bucket-&gt;sel
<span class="enscript-function-name">6:</span>
.if $0 == STRET
	<span class="enscript-keyword">teq</span>	r12, r2
.else
	<span class="enscript-keyword">teq</span>	r12, r1
.endif
	<span class="enscript-keyword">bne</span>	8f
	<span class="enscript-keyword">ldr</span>	r12, [r9, #4]		// r12 = bucket-&gt;imp

.if $0 == STRET
	<span class="enscript-keyword">tst</span>	r12, r12		// set ne for stret forwarding
.else
	<span class="enscript-keyword">//</span> eq already set for nonstret forwarding by `teq` above
.endif

.endmacro

.macro CacheLookup2
	<span class="enscript-keyword">
</span><span class="enscript-function-name">8:</span>	
	<span class="enscript-keyword">cmp</span>	r12, #1
	<span class="enscript-keyword">blo</span>	8f			// if (bucket-&gt;sel == 0) cache miss
	<span class="enscript-keyword">it</span>	eq			// if (bucket-&gt;sel == 1) cache wrap
	<span class="enscript-keyword">ldreq</span>	r9, [r9, #4]		// bucket-&gt;imp is before first bucket
	<span class="enscript-keyword">ldr</span>	r12, [r9, #8]!		// r12 = (++bucket)-&gt;sel
	<span class="enscript-keyword">b</span>	6b
<span class="enscript-function-name">8:</span>

.endmacro

/////////////////////////////////////////////////////////////////////
//
// GetClassFromIsa	return-type
//
// Given an Isa, return the class for the Isa.
//
// Takes:
//	  r9 = class
//
// On exit: r12 clobbered
//          r9 contains the class for this Isa.
//
/////////////////////////////////////////////////////////////////////
.macro GetClassFromIsa

#if SUPPORT_INDEXED_ISA
	<span class="enscript-keyword">//</span> Note: We are doing a little wasted work here to load values we might not
	<span class="enscript-keyword">//</span> need.  Branching turns out to be even worse when performance was measured.
	<span class="enscript-keyword">MI_GET_ADDRESS(r12,</span> _objc_indexed_classes)
	<span class="enscript-keyword">tst.w</span>	r9, #ISA_INDEX_IS_NPI
	<span class="enscript-keyword">itt</span>	ne
	<span class="enscript-keyword">ubfxne</span>	r9, r9, #ISA_INDEX_SHIFT, #ISA_INDEX_BITS
	<span class="enscript-keyword">ldrne.w</span>	r9, [r12, r9, lsl #2]
#endif

.endmacro


/********************************************************************
 <span class="enscript-keyword">*</span> IMP cache_getImp(Class cls, SEL sel)
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> On entry:    r0 = class whose cache is to be searched
 <span class="enscript-keyword">*</span>              r1 = selector to search for
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> If found, returns method implementation.
 <span class="enscript-keyword">*</span> If not found, returns NULL.
 <span class="enscript-keyword">********************************************************************/
</span>
	<span class="enscript-keyword">STATIC_ENTRY</span> _cache_getImp

	<span class="enscript-keyword">mov</span>	r9, r0
	<span class="enscript-keyword">CacheLookup</span> NORMAL
	<span class="enscript-keyword">//</span> cache hit, IMP in r12
	<span class="enscript-keyword">mov</span>	r0, r12
	<span class="enscript-keyword">bx</span>	lr			// return imp
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">CacheLookup2</span> GETIMP
	<span class="enscript-keyword">//</span> cache miss, return nil
	<span class="enscript-keyword">mov</span>	r0, #0
	<span class="enscript-keyword">bx</span>	lr

	<span class="enscript-keyword">END_ENTRY</span> _cache_getImp


/********************************************************************
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> id objc_msgSend(id self, SEL _cmd, ...)<span class="enscript-comment">;
 * IMP objc_msgLookup(id self, SEL _cmd, ...);
</span> <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> objc_msgLookup ABI:
 <span class="enscript-keyword">*</span> IMP returned in r12
 <span class="enscript-keyword">*</span> Forwarding returned in Z flag
 <span class="enscript-keyword">*</span> r9 reserved for our use but not used
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">********************************************************************/
</span>
	<span class="enscript-keyword">ENTRY</span> _objc_msgSend
	<span class="enscript-keyword">MESSENGER_START
</span>	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">cbz</span>	r0, LNilReceiver_f

	<span class="enscript-keyword">ldr</span>	r9, [r0]		// r9 = self-&gt;isa
	<span class="enscript-keyword">GetClassFromIsa</span>			// r9 = class
	<span class="enscript-keyword">CacheLookup</span> NORMAL
	<span class="enscript-keyword">//</span> cache hit, IMP in r12, eq already set for nonstret forwarding
	<span class="enscript-keyword">MESSENGER_END_FAST
</span>	<span class="enscript-keyword">bx</span>	r12			// call imp

	<span class="enscript-keyword">CacheLookup2</span> NORMAL
	<span class="enscript-keyword">//</span> cache miss
	<span class="enscript-keyword">ldr</span>	r9, [r0]		// r9 = self-&gt;isa
	<span class="enscript-keyword">GetClassFromIsa</span>			// r9 = class
	<span class="enscript-keyword">MESSENGER_END_SLOW
</span>	<span class="enscript-keyword">b</span>	__objc_msgSend_uncached

<span class="enscript-function-name">LNilReceiver:</span>
	<span class="enscript-keyword">//</span> r0 is already zero
	<span class="enscript-keyword">mov</span>	r1, #0
	<span class="enscript-keyword">mov</span>	r2, #0
	<span class="enscript-keyword">mov</span>	r3, #0
	<span class="enscript-keyword">FP_RETURN_ZERO
</span>	<span class="enscript-keyword">MESSENGER_END_NIL
</span>	<span class="enscript-keyword">bx</span>	lr	

	<span class="enscript-keyword">END_ENTRY</span> _objc_msgSend

	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">ENTRY</span> _objc_msgLookup

	<span class="enscript-keyword">cbz</span>	r0, LNilReceiver_f

	<span class="enscript-keyword">ldr</span>	r9, [r0]		// r9 = self-&gt;isa
	<span class="enscript-keyword">GetClassFromIsa</span>			// r9 = class
	<span class="enscript-keyword">CacheLookup</span> NORMAL
	<span class="enscript-keyword">//</span> cache hit, IMP in r12, eq already set for nonstret forwarding
	<span class="enscript-keyword">bx</span>	lr

	<span class="enscript-keyword">CacheLookup2</span> NORMAL
	<span class="enscript-keyword">//</span> cache miss
	<span class="enscript-keyword">ldr</span>	r9, [r0]		// r9 = self-&gt;isa
	<span class="enscript-keyword">GetClassFromIsa</span>			// r9 = class
	<span class="enscript-keyword">b</span>	__objc_msgLookup_uncached

<span class="enscript-function-name">LNilReceiver:</span>
	<span class="enscript-keyword">MI_GET_ADDRESS(r12,</span> __objc_msgNil)
	<span class="enscript-keyword">bx</span>	lr

	<span class="enscript-keyword">END_ENTRY</span> _objc_msgLookup


	<span class="enscript-keyword">STATIC_ENTRY</span> __objc_msgNil
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">//</span> r0 is already zero
	<span class="enscript-keyword">mov</span>	r1, #0
	<span class="enscript-keyword">mov</span>	r2, #0
	<span class="enscript-keyword">mov</span>	r3, #0
	<span class="enscript-keyword">FP_RETURN_ZERO
</span>	<span class="enscript-keyword">bx</span>	lr
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">END_ENTRY</span> __objc_msgNil


/********************************************************************
 <span class="enscript-keyword">*</span> void objc_msgSend_stret(void *st_addr, id self, SEL op, ...)<span class="enscript-comment">;
 * IMP objc_msgLookup_stret(void *st_addr, id self, SEL op, ...);
</span> <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> objc_msgSend_stret is the struct-return form of msgSend.
 <span class="enscript-keyword">*</span> The ABI calls for r0 to be used as the address of the structure
 <span class="enscript-keyword">*</span> being returned, with the parameters in the succeeding registers.
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> On entry: r0 is the address where the structure is returned,
 <span class="enscript-keyword">*</span>           r1 is the message receiver,
 <span class="enscript-keyword">*</span>           r2 is the selector
 <span class="enscript-keyword">********************************************************************/
</span>
	<span class="enscript-keyword">ENTRY</span> _objc_msgSend_stret
	<span class="enscript-keyword">MESSENGER_START
</span>	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">cbz</span>	r1, LNilReceiver_f

	<span class="enscript-keyword">ldr</span>	r9, [r1]		// r9 = self-&gt;isa
	<span class="enscript-keyword">GetClassFromIsa</span>			// r9 = class
	<span class="enscript-keyword">CacheLookup</span> STRET
	<span class="enscript-keyword">//</span> cache hit, IMP in r12, ne already set for stret forwarding
	<span class="enscript-keyword">MESSENGER_END_FAST
</span>	<span class="enscript-keyword">bx</span>	r12

	<span class="enscript-keyword">CacheLookup2</span> STRET
	<span class="enscript-keyword">//</span> cache miss
	<span class="enscript-keyword">ldr</span>	r9, [r1]		// r9 = self-&gt;isa
	<span class="enscript-keyword">GetClassFromIsa</span>			// r9 = class
	<span class="enscript-keyword">MESSENGER_END_SLOW
</span>	<span class="enscript-keyword">b</span>	__objc_msgSend_stret_uncached

<span class="enscript-function-name">LNilReceiver:</span>
	<span class="enscript-keyword">MESSENGER_END_NIL
</span>	<span class="enscript-keyword">bx</span>	lr
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">END_ENTRY</span> _objc_msgSend_stret


	<span class="enscript-keyword">ENTRY</span> _objc_msgLookup_stret
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">cbz</span>	r1, LNilReceiver_f

	<span class="enscript-keyword">ldr</span>	r9, [r1]		// r9 = self-&gt;isa
	<span class="enscript-keyword">GetClassFromIsa</span>			// r9 = class
	<span class="enscript-keyword">CacheLookup</span> STRET
	<span class="enscript-keyword">//</span> cache hit, IMP in r12, ne already set for stret forwarding
	<span class="enscript-keyword">bx</span>	lr

	<span class="enscript-keyword">CacheLookup2</span> STRET
	<span class="enscript-keyword">//</span> cache miss
	<span class="enscript-keyword">ldr</span>	r9, [r1]		// r9 = self-&gt;isa
	<span class="enscript-keyword">GetClassFromIsa</span>			// r9 = class
	<span class="enscript-keyword">b</span>	__objc_msgLookup_stret_uncached

<span class="enscript-function-name">LNilReceiver:</span>
	<span class="enscript-keyword">MI_GET_ADDRESS(r12,</span> __objc_msgNil_stret)
	<span class="enscript-keyword">bx</span>	lr

	<span class="enscript-keyword">END_ENTRY</span> _objc_msgLookup_stret


	<span class="enscript-keyword">STATIC_ENTRY</span> __objc_msgNil_stret
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">bx</span>	lr

	<span class="enscript-keyword">END_ENTRY</span> __objc_msgNil_stret


/********************************************************************
 <span class="enscript-keyword">*</span> id objc_msgSendSuper(struct objc_super *super, SEL op, ...)
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> struct objc_super {
 <span class="enscript-keyword">*</span>     id receiver<span class="enscript-comment">;
 *     Class cls;	// the class to search
</span> <span class="enscript-keyword">*</span> }
 <span class="enscript-keyword">********************************************************************/
</span>
	<span class="enscript-keyword">ENTRY</span> _objc_msgSendSuper
	<span class="enscript-keyword">MESSENGER_START
</span>	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">ldr</span>	r9, [r0, #CLASS]	// r9 = struct super-&gt;class
	<span class="enscript-keyword">CacheLookup</span> NORMAL
	<span class="enscript-keyword">//</span> cache hit, IMP in r12, eq already set for nonstret forwarding
	<span class="enscript-keyword">ldr</span>	r0, [r0, #RECEIVER]	// load real receiver
	<span class="enscript-keyword">MESSENGER_END_FAST
</span>	<span class="enscript-keyword">bx</span>	r12			// call imp

	<span class="enscript-keyword">CacheLookup2</span> NORMAL
	<span class="enscript-keyword">//</span> cache miss
	<span class="enscript-keyword">ldr</span>	r9, [r0, #CLASS]	// r9 = struct super-&gt;class
	<span class="enscript-keyword">ldr</span>	r0, [r0, #RECEIVER]	// load real receiver
	<span class="enscript-keyword">MESSENGER_END_SLOW
</span>	<span class="enscript-keyword">b</span>	__objc_msgSend_uncached
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">END_ENTRY</span> _objc_msgSendSuper


/********************************************************************
 <span class="enscript-keyword">*</span> id objc_msgSendSuper2(struct objc_super *super, SEL op, ...)
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> struct objc_super {
 <span class="enscript-keyword">*</span>     id receiver<span class="enscript-comment">;
 *     Class cls;	// SUBCLASS of the class to search
</span> <span class="enscript-keyword">*</span> }
 <span class="enscript-keyword">********************************************************************/
</span>	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">ENTRY</span> _objc_msgSendSuper2
	<span class="enscript-keyword">MESSENGER_START
</span>	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">ldr</span>	r9, [r0, #CLASS]	// class = struct super-&gt;class
	<span class="enscript-keyword">ldr</span>	r9, [r9, #SUPERCLASS]   // class = class-&gt;superclass
	<span class="enscript-keyword">CacheLookup</span> NORMAL
	<span class="enscript-keyword">//</span> cache hit, IMP in r12, eq already set for nonstret forwarding
	<span class="enscript-keyword">ldr</span>	r0, [r0, #RECEIVER]	// load real receiver
	<span class="enscript-keyword">MESSENGER_END_FAST
</span>	<span class="enscript-keyword">bx</span>	r12			// call imp

	<span class="enscript-keyword">CacheLookup2</span> NORMAL
	<span class="enscript-keyword">//</span> cache miss
	<span class="enscript-keyword">ldr</span>	r9, [r0, #CLASS]	// class = struct super-&gt;class
	<span class="enscript-keyword">ldr</span>	r9, [r9, #SUPERCLASS]   // class = class-&gt;superclass
	<span class="enscript-keyword">ldr</span>	r0, [r0, #RECEIVER]	// load real receiver
	<span class="enscript-keyword">MESSENGER_END_SLOW
</span>	<span class="enscript-keyword">b</span>	__objc_msgSend_uncached
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">END_ENTRY</span> _objc_msgSendSuper2

	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">ENTRY</span> _objc_msgLookupSuper2
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">ldr</span>	r9, [r0, #CLASS]	// class = struct super-&gt;class
	<span class="enscript-keyword">ldr</span>	r9, [r9, #SUPERCLASS]   // class = class-&gt;superclass
	<span class="enscript-keyword">CacheLookup</span> NORMAL
	<span class="enscript-keyword">//</span> cache hit, IMP in r12, eq already set for nonstret forwarding
	<span class="enscript-keyword">ldr</span>	r0, [r0, #RECEIVER]	// load real receiver
	<span class="enscript-keyword">bx</span>	lr

	<span class="enscript-keyword">CacheLookup2</span> NORMAL
	<span class="enscript-keyword">//</span> cache miss
	<span class="enscript-keyword">ldr</span>	r9, [r0, #CLASS]
	<span class="enscript-keyword">ldr</span>	r9, [r9, #SUPERCLASS]	// r9 = class to search
	<span class="enscript-keyword">ldr</span>	r0, [r0, #RECEIVER]	// load real receiver
	<span class="enscript-keyword">b</span>	__objc_msgLookup_uncached
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">END_ENTRY</span> _objc_msgLookupSuper2


/********************************************************************
 <span class="enscript-keyword">*</span> void objc_msgSendSuper_stret(void *st_addr, objc_super *self, SEL op, ...)<span class="enscript-comment">;
 *
</span> <span class="enscript-keyword">*</span> objc_msgSendSuper_stret is the struct-return form of msgSendSuper.
 <span class="enscript-keyword">*</span> The ABI calls for r0 to be used as the address of the structure
 <span class="enscript-keyword">*</span> being returned, with the parameters in the succeeding registers.
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> On entry: r0 is the address where the structure is returned,
 <span class="enscript-keyword">*</span>           r1 is the address of the objc_super structure,
 <span class="enscript-keyword">*</span>           r2 is the selector
 <span class="enscript-keyword">********************************************************************/
</span>
	<span class="enscript-keyword">ENTRY</span> _objc_msgSendSuper_stret
	<span class="enscript-keyword">MESSENGER_START
</span>	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">ldr</span>	r9, [r1, #CLASS]	// r9 = struct super-&gt;class
	<span class="enscript-keyword">CacheLookup</span> STRET
	<span class="enscript-keyword">//</span> cache hit, IMP in r12, ne already set for stret forwarding
	<span class="enscript-keyword">ldr</span>	r1, [r1, #RECEIVER]	// load real receiver
	<span class="enscript-keyword">MESSENGER_END_FAST
</span>	<span class="enscript-keyword">bx</span>	r12			// call imp

	<span class="enscript-keyword">CacheLookup2</span> STRET
	<span class="enscript-keyword">//</span> cache miss
	<span class="enscript-keyword">ldr</span>	r9, [r1, #CLASS]	// r9 = struct super-&gt;class
	<span class="enscript-keyword">ldr</span>	r1, [r1, #RECEIVER]	// load real receiver
	<span class="enscript-keyword">MESSENGER_END_SLOW
</span>	<span class="enscript-keyword">b</span>	__objc_msgSend_stret_uncached

	<span class="enscript-keyword">END_ENTRY</span> _objc_msgSendSuper_stret


/********************************************************************
 <span class="enscript-keyword">*</span> id objc_msgSendSuper2_stret
 <span class="enscript-keyword">********************************************************************/
</span>
	<span class="enscript-keyword">ENTRY</span> _objc_msgSendSuper2_stret
	<span class="enscript-keyword">MESSENGER_START
</span>	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">ldr</span>	r9, [r1, #CLASS]	// class = struct super-&gt;class
	<span class="enscript-keyword">ldr</span>	r9, [r9, #SUPERCLASS]	// class = class-&gt;superclass
	<span class="enscript-keyword">CacheLookup</span> STRET
	<span class="enscript-keyword">//</span> cache hit, IMP in r12, ne already set for stret forwarding
	<span class="enscript-keyword">ldr</span>	r1, [r1, #RECEIVER]	// load real receiver
	<span class="enscript-keyword">MESSENGER_END_FAST
</span>	<span class="enscript-keyword">bx</span>	r12			// call imp

	<span class="enscript-keyword">CacheLookup2</span> STRET
	<span class="enscript-keyword">//</span> cache miss
	<span class="enscript-keyword">ldr</span>	r9, [r1, #CLASS]	// class = struct super-&gt;class
	<span class="enscript-keyword">ldr</span>	r9, [r9, #SUPERCLASS]	// class = class-&gt;superclass
	<span class="enscript-keyword">ldr</span>	r1, [r1, #RECEIVER]	// load real receiver
	<span class="enscript-keyword">MESSENGER_END_SLOW
</span>	<span class="enscript-keyword">b</span>	__objc_msgSend_stret_uncached
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">END_ENTRY</span> _objc_msgSendSuper2_stret

	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">ENTRY</span> _objc_msgLookupSuper2_stret
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">ldr</span>	r9, [r1, #CLASS]	// class = struct super-&gt;class
	<span class="enscript-keyword">ldr</span>	r9, [r9, #SUPERCLASS]	// class = class-&gt;superclass
	<span class="enscript-keyword">CacheLookup</span> STRET
	<span class="enscript-keyword">//</span> cache hit, IMP in r12, ne already set for stret forwarding
	<span class="enscript-keyword">ldr</span>	r1, [r1, #RECEIVER]	// load real receiver
	<span class="enscript-keyword">bx</span>	lr

	<span class="enscript-keyword">CacheLookup2</span> STRET
	<span class="enscript-keyword">//</span> cache miss
	<span class="enscript-keyword">ldr</span>	r9, [r1, #CLASS]
	<span class="enscript-keyword">ldr</span>	r9, [r9, #SUPERCLASS]	// r9 = class to search
	<span class="enscript-keyword">ldr</span>	r1, [r1, #RECEIVER]	// load real receiver
	<span class="enscript-keyword">b</span>	__objc_msgLookup_stret_uncached
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">END_ENTRY</span> _objc_msgLookupSuper2_stret

	<span class="enscript-keyword">
</span>/////////////////////////////////////////////////////////////////////
//
// MethodTableLookup	NORMAL|STRET
//
// Locate the implementation for a selector in a class's method lists.
//
// Takes: 
//	  $0 = NORMAL, STRET
//	  r0 or r1 (STRET) = receiver
//	  r1 or r2 (STRET) = selector
//	  r9 = class to search in
//
// On exit: IMP in r12, eq/ne set for forwarding
//
/////////////////////////////////////////////////////////////////////
	<span class="enscript-keyword">
</span>.macro MethodTableLookup
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">stmfd</span>	sp!, {r0-r3,r7,lr}
	<span class="enscript-keyword">add</span>	r7, sp, #16
	<span class="enscript-keyword">sub</span>	sp, #8			// align stack
	<span class="enscript-keyword">FP_SAVE
</span>
.if $0 == NORMAL
	<span class="enscript-keyword">//</span> receiver already in r0
	<span class="enscript-keyword">//</span> selector already in r1
.else
	<span class="enscript-keyword">mov</span> 	r0, r1			// receiver
	<span class="enscript-keyword">mov</span> 	r1, r2			// selector
.endif
	<span class="enscript-keyword">mov</span>	r2, r9			// class to search

	<span class="enscript-keyword">blx</span>	__class_lookupMethodAndLoadCache3
	<span class="enscript-keyword">mov</span>	r12, r0			// r12 = IMP
	<span class="enscript-keyword">
</span>.if $0 == NORMAL
	<span class="enscript-keyword">cmp</span>	r12, r12		// set eq for nonstret forwarding
.else
	<span class="enscript-keyword">tst</span>	r12, r12		// set ne for stret forwarding
.endif

	<span class="enscript-keyword">FP_RESTORE
</span>	<span class="enscript-keyword">add</span>	sp, #8			// align stack
	<span class="enscript-keyword">ldmfd</span>	sp!, {r0-r3,r7,lr}

.endmacro


/********************************************************************
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> _objc_msgSend_uncached
 <span class="enscript-keyword">*</span> _objc_msgSend_stret_uncached
 <span class="enscript-keyword">*</span> _objc_msgLookup_uncached
 <span class="enscript-keyword">*</span> _objc_msgLookup_stret_uncached
 <span class="enscript-keyword">*</span> The uncached method lookup.
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">********************************************************************/
</span>
	<span class="enscript-keyword">STATIC_ENTRY</span> __objc_msgSend_uncached

	<span class="enscript-keyword">//</span> THIS IS NOT A CALLABLE C FUNCTION
	<span class="enscript-keyword">//</span> Out-of-band r9 is the class to search
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">MethodTableLookup</span> NORMAL	// returns IMP in r12
	<span class="enscript-keyword">bx</span>	r12

	<span class="enscript-keyword">END_ENTRY</span> __objc_msgSend_uncached


	<span class="enscript-keyword">STATIC_ENTRY</span> __objc_msgSend_stret_uncached

	<span class="enscript-keyword">//</span> THIS IS NOT A CALLABLE C FUNCTION
	<span class="enscript-keyword">//</span> Out-of-band r9 is the class to search

	<span class="enscript-keyword">MethodTableLookup</span> STRET		// returns IMP in r12
	<span class="enscript-keyword">bx</span>	r12
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">END_ENTRY</span> __objc_msgSend_stret_uncached

	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">STATIC_ENTRY</span> __objc_msgLookup_uncached

	<span class="enscript-keyword">//</span> THIS IS NOT A CALLABLE C FUNCTION
	<span class="enscript-keyword">//</span> Out-of-band r9 is the class to search
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">MethodTableLookup</span> NORMAL	// returns IMP in r12
	<span class="enscript-keyword">bx</span>	lr

	<span class="enscript-keyword">END_ENTRY</span> __objc_msgLookup_uncached


	<span class="enscript-keyword">STATIC_ENTRY</span> __objc_msgLookup_stret_uncached

	<span class="enscript-keyword">//</span> THIS IS NOT A CALLABLE C FUNCTION
	<span class="enscript-keyword">//</span> Out-of-band r9 is the class to search

	<span class="enscript-keyword">MethodTableLookup</span> STRET		// returns IMP in r12
	<span class="enscript-keyword">bx</span>	lr
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">END_ENTRY</span> __objc_msgLookup_stret_uncached

	<span class="enscript-keyword">
</span>/********************************************************************
*
* id _objc_msgForward(id self, SEL _cmd,...)<span class="enscript-comment">;
*
</span>* _objc_msgForward and _objc_msgForward_stret are the externally-callable
*   functions returned by things like method_getImplementation().
* _objc_msgForward_impcache is the function pointer actually stored in
*   method caches.
*
********************************************************************/

	<span class="enscript-keyword">MI_EXTERN(__objc_forward_handler)
</span>	<span class="enscript-keyword">MI_EXTERN(__objc_forward_stret_handler)
</span>	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">STATIC_ENTRY</span> __objc_msgForward_impcache
	<span class="enscript-keyword">//</span> Method cache version

	<span class="enscript-keyword">//</span> THIS IS NOT A CALLABLE C FUNCTION
	<span class="enscript-keyword">//</span> Out-of-band Z is 0 (EQ) for normal, 1 (NE) for stret

	<span class="enscript-keyword">MESSENGER_START
</span>	<span class="enscript-keyword">nop
</span>	<span class="enscript-keyword">MESSENGER_END_SLOW
</span>
	<span class="enscript-keyword">beq</span>	__objc_msgForward
	<span class="enscript-keyword">b</span>	__objc_msgForward_stret
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">END_ENTRY</span> __objc_msgForward_impcache
	<span class="enscript-keyword">
</span>
	<span class="enscript-keyword">ENTRY</span> __objc_msgForward
	<span class="enscript-keyword">//</span> Non-stret version

	<span class="enscript-keyword">MI_GET_EXTERN(r12,</span> __objc_forward_handler)
	<span class="enscript-keyword">ldr</span>	r12, [r12]
	<span class="enscript-keyword">bx</span>	r12

	<span class="enscript-keyword">END_ENTRY</span> __objc_msgForward


	<span class="enscript-keyword">ENTRY</span> __objc_msgForward_stret
	<span class="enscript-keyword">//</span> Struct-return version

	<span class="enscript-keyword">MI_GET_EXTERN(r12,</span> __objc_forward_stret_handler)
	<span class="enscript-keyword">ldr</span>	r12, [r12]
	<span class="enscript-keyword">bx</span>	r12

	<span class="enscript-keyword">END_ENTRY</span> __objc_msgForward_stret


	<span class="enscript-keyword">ENTRY</span> _objc_msgSend_noarg
	<span class="enscript-keyword">b</span> 	_objc_msgSend
	<span class="enscript-keyword">END_ENTRY</span> _objc_msgSend_noarg

	<span class="enscript-keyword">ENTRY</span> _objc_msgSend_debug
	<span class="enscript-keyword">b</span>	_objc_msgSend
	<span class="enscript-keyword">END_ENTRY</span> _objc_msgSend_debug

	<span class="enscript-keyword">ENTRY</span> _objc_msgSendSuper2_debug
	<span class="enscript-keyword">b</span>	_objc_msgSendSuper2
	<span class="enscript-keyword">END_ENTRY</span> _objc_msgSendSuper2_debug

	<span class="enscript-keyword">ENTRY</span> _objc_msgSend_stret_debug
	<span class="enscript-keyword">b</span>	_objc_msgSend_stret
	<span class="enscript-keyword">END_ENTRY</span> _objc_msgSend_stret_debug

	<span class="enscript-keyword">ENTRY</span> _objc_msgSendSuper2_stret_debug
	<span class="enscript-keyword">b</span>	_objc_msgSendSuper2_stret
	<span class="enscript-keyword">END_ENTRY</span> _objc_msgSendSuper2_stret_debug


	<span class="enscript-keyword">ENTRY</span> _method_invoke
	<span class="enscript-keyword">//</span> r1 is method triplet instead of SEL
	<span class="enscript-keyword">ldr</span>	r12, [r1, #METHOD_IMP]
	<span class="enscript-keyword">ldr</span>	r1, [r1, #METHOD_NAME]
	<span class="enscript-keyword">bx</span>	r12
	<span class="enscript-keyword">END_ENTRY</span> _method_invoke


	<span class="enscript-keyword">ENTRY</span> _method_invoke_stret
	<span class="enscript-keyword">//</span> r2 is method triplet instead of SEL
	<span class="enscript-keyword">ldr</span>	r12, [r2, #METHOD_IMP]
	<span class="enscript-keyword">ldr</span>	r2, [r2, #METHOD_NAME]
	<span class="enscript-keyword">bx</span>	r12
	<span class="enscript-keyword">END_ENTRY</span> _method_invoke_stret
	<span class="enscript-keyword">
</span>
.section __DATA,__objc_msg_break
.long 0
.long 0
	<span class="enscript-keyword">
</span>#endif
</pre>
<hr />
</body></html>